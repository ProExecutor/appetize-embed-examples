<html>

<head>
  <script>
    // helper function
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    // query params
    var publicKey = getUrlParameter('publicKey') || 'demo_phq04c56jnvrkg0bn9w5ep4m9r';
    var device = getUrlParameter('device');
    var scale = getUrlParameter('scale');
    var osVersion = getUrlParameter('osVersion');
    var deviceColor = getUrlParameter('deviceColor');
    var centered = getUrlParameter('centered');
    var orientation = getUrlParameter('orientation');
    var heartbeatInterval = parseInt(getUrlParameter('heartbeatInterval')) || 30;
    var restartInterval = parseInt(getUrlParameter('restartInterval')) || 5 * 60;

    // start when DOM is interactive
    var iframe;
    document.onreadystatechange = function () {
      if (document.readyState == "interactive") {
        iframe = document.getElementById('myIframe');
        iframe.src = 'https://appetize.io/embed/' + publicKey + '?device=' + device + '&scale=' + scale + '&orientation=' + orientation + '&osVersion=' + osVersion + '&deviceColor=' + deviceColor + '&centered=' + centered + '&xdocMsg=true';
      }
    }

    // local variable to prevent start() from being called twice after iframe src dynamically updated
    var started;
    function start() {
      if (started) return;
      started = true;
      setTimeout(function () {
        requestSession();
      }, 1000);

      setInterval(function () {
        endSession();
        requestSession();
      }, restartInterval * 1000);

      setInterval(function () {
        sendHeartbeat();
      }, heartbeatInterval * 1000);
    }


    function requestSession() {
      console.log('starting session');
      iframe.contentWindow.postMessage('requestSession', '*');
    }
    function endSession() {
      console.log('ending session');
      iframe.contentWindow.postMessage('endSession', '*');
    }
    function sendHeartbeat() {
      console.log('sending heartbeat');
      iframe.contentWindow.postMessage('heartbeat', '*');
    }


    // Receiving messages from iframe in parent window
    var messageEventHandler = function (event) {

      // if(event.data == 'userInteractionReceived'){
      //     console.log(event.data);
      // }

      // if(event.data == 'sessionRequested'){
      //     console.log(event.data);
      // }

      // else if(event.data == 'userError'){
      //     console.log(event.data);
      // }

      // else if(event.data == 'appLaunch'){
      //     console.log(event.data);
      // }

      // else if(event.data == 'sessionEnded'){
      //     console.log(event.data);
      // }

      // else
      // 	console.log(event.data);

    };

    window.addEventListener('message', messageEventHandler, false);
  </script>
</head>

<body>
  <iframe id="myIframe" onload="start(this)" width="100%" height="100%" frameborder="0" scrolling="no"></iframe>
</body>

</html>